name: Deploy to Production Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH and restart Docker
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 185.169.54.164
          username: webmaster
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd /var/www/cargodb

            echo "=== UPDATE CODE ==="
            git fetch origin master
            git reset --hard origin/master

            echo "=== LOAD ENV ==="
            export $(grep -v '^#' .env.prod | xargs)

            echo "=== BACKUP POSTGRES (local, external to docker) ==="
            mkdir -p backups
            PGPASSWORD="$DB_PASSWORD" pg_dump \
              -h "$IP_POSTGRES" \
              -p "$DB_PORT" \
              -U "$DB_USER" \
              "$DB_NAME" \
              > backups/backup_$(date +%F_%H-%M-%S).sql

            echo "=== ROTATE BACKUPS (keep 3) ==="
            ls -t backups/*.sql | tail -n +4 | xargs -r rm --

            echo "=== MIGRATIONS ==="
            docker compose -f docker-compose.prod.yml run --rm cargo_app \
              python manage.py migrate --noinput

            echo "=== COLLECTSTATIC ==="
            docker compose -f docker-compose.prod.yml run --rm cargo_app \
              python manage.py collectstatic --noinput --clear

            echo "=== RESTART APP ==="
            docker compose -f docker-compose.prod.yml restart cargo_app

            echo "=== DEPLOY DONE ==="
