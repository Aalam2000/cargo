name: Deploy PROD (no rebuild, with backups)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 185.169.54.164
          username: webmaster
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd /var/www/cargodb

            echo "=== UPDATE CODE ==="
            git fetch origin master
            git reset --hard origin/master

            echo "=== BACKUP DB ==="
            mkdir -p backups
            docker exec cargo_db pg_dump -U cargo cargo \
              > backups/backup_$(date +%F_%H-%M-%S).sql

            # keep last 3 backups
            ls -t backups/*.sql | tail -n +4 | xargs -r rm --

            echo "=== MIGRATIONS ==="
            docker compose -f docker-compose.prod.yml run --rm cargo_app \
              python manage.py migrate --noinput

            echo "=== COLLECTSTATIC ==="
            docker compose -f docker-compose.prod.yml run --rm cargo_app \
              python manage.py collectstatic --noinput --clear

            echo "=== RESTART APP ==="
            docker compose -f docker-compose.prod.yml restart cargo_app

            echo "DEPLOY DONE"
